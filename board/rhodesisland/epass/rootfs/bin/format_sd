#!/bin/sh

DEVICE="/dev/mmcblk0"

if [ ! -b "$DEVICE" ]; then
    echo "========ERROR========"
    echo "SD Card device $DEVICE not found!"
    echo "Please make sure the SD card is connected."
    echo "========ERROR========"
    exit 1
fi


echo " ====WARNING==== "
echo "This will FORMAT the SD card at $DEVICE"
echo "All data on the SD card will be LOST!"
echo " ====WARNING==== "

echo "Are You Sure to Continue? (1:YES /other:no): "
read -n1 CONFIRM
echo ""
if [ "$CONFIRM" != "1" ]; then
    echo "Aborted."
    exit 0
fi

umount "${DEVICE}p1" 2>/dev/null
umount "/sd" 2>/dev/null

echo "Delete partitions..."
{
    echo "o"
    echo "w"
} | fdisk "$DEVICE"

echo "done"
echo "Waiting for discovery..."
sleep 2

echo "Creating new partition..."
{
    echo "n"      # New partition
    echo "p"      # Primary partition
    echo "1"      # 1
    echo ""       # 
    echo ""       # 
    echo "t"      # type
    echo "c"      # FAT32 (LBA)
    echo "w"      # write and exit
} | fdisk "$DEVICE"

echo "done"
echo "Waiting for discovery..."
sleep 2

PARTITION="${DEVICE}p1"
echo "format $PARTITION as FAT32..."
mkdosfs -F 32 "$PARTITION"
FORMAT_RET=$?

if [ $FORMAT_RET -eq 0 ]; then
    echo "Format completed!"
else
    echo "Format failed!"
    exit 1
fi

echo "Try to mount the SD card..."
mkdir /sd
mount /dev/mmcblk0p1 /sd
mount_ret=$?

if [ $mount_ret -eq 0 ]; then
    echo "SD Card Mounted!"  
else
    echo "SD Mount Failed!"
    return 1
fi

touch /tmp/sd_mounted
mkdir -p /sd/assets/
echo "请把资源文件放入/assets/目录下。" > /sd/README.txt

if [ -d "/sys/kernel/config/usb_gadget/g1/configs/c.1/ffs.mtp" ]; then
    echo "Restarting MTP service..."
    usbctl stop
    usbctl mtp
fi

echo "All done!"
